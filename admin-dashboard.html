async function loadAllUsers() {
    try {
        document.getElementById('loading-users').classList.remove('hidden');
        document.getElementById('users-grid').classList.add('hidden');
        
        // Try to get users from SERVER (not just localStorage)
        const serverUsers = await getUsersFromServer();
        const localUsers = JSON.parse(localStorage.getItem('all_users') || '[]');
        
        // Combine server and local users (server takes priority)
        const allUsers = [...serverUsers, ...localUsers.filter(localUser => 
            !serverUsers.some(serverUser => serverUser.id === localUser.id)
        )];
        
        // Update statistics
        updateStatistics(allUsers);
        
        // Display users with token information
        displayUsers(allUsers);
        
        document.getElementById('loading-users').classList.add('hidden');
        document.getElementById('users-grid').classList.remove('hidden');
        
    } catch (error) {
        console.error('Error loading users:', error);
        // Fallback to localStorage only
        const localUsers = JSON.parse(localStorage.getItem('all_users') || '[]');
        updateStatistics(localUsers);
        displayUsers(localUsers);
        document.getElementById('loading-users').classList.add('hidden');
        document.getElementById('users-grid').classList.remove('hidden');
    }
}

async function getUsersFromServer() {
    try {
        const response = await fetch('https://spontaneous-fenglisu-09c8c8.netlify.app/.netlify/functions/auth-callback/users', {
            headers: {
                'Authorization': 'Bearer admin-1223230659972173914'
            }
        });
        
        if (response.ok) {
            const data = await response.json();
            return data.users || [];
        }
    } catch (error) {
        console.error('Failed to fetch users from server:', error);
    }
    return [];
}

function displayUsers(users) {
    const usersGrid = document.getElementById('users-grid');
    
    if (users.length === 0) {
        usersGrid.innerHTML = `
            <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #b9bbbe;">
                <h3>No users found</h3>
                <p>User data will appear here as people authenticate with your app.</p>
            </div>
        `;
        return;
    }

    // Sort users by most recent login
    users.sort((a, b) => new Date(b.lastLogin || b.loginTime || b.loginTimestamp) - new Date(a.lastLogin || a.loginTime || a.loginTimestamp));

    usersGrid.innerHTML = users.map(user => `
        <div class="user-card">
            <div class="user-header">
                <img src="${getAvatarUrl(user)}" class="user-avatar" 
                     onerror="this.src='https://cdn.discordapp.com/embed/avatars/0.png'">
                <div class="user-info">
                    <div class="username">
                        ${user.username}
                        ${user.id === ADMIN_USER_ID ? '<span class="admin-indicator">ADMIN</span>' : ''}
                    </div>
                    <div class="user-id">${user.id}</div>
                </div>
            </div>
            
            <div class="user-details">
                <div class="detail-row">
                    <span class="detail-label">Email:</span>
                    <span>${user.email || 'Not provided'}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Discriminator:</span>
                    <span>#${user.discriminator || '0'}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Logins:</span>
                    <span>${user.loginCount || 1}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Access Token:</span>
                    <span style="font-family: monospace; font-size: 0.8em;">
                        ${user.access_token ? '‚Ä¢‚Ä¢‚Ä¢' + user.access_token.slice(-8) : 'Not available'}
                    </span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Refresh Token:</span>
                    <span style="font-family: monospace; font-size: 0.8em;">
                        ${user.refresh_token ? '‚Ä¢‚Ä¢‚Ä¢' + user.refresh_token.slice(-8) : 'Not available'}
                    </span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">First Login:</span>
                    <span class="timestamp">${formatDate(user.firstLogin || user.loginTime || user.loginTimestamp)}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Last Login:</span>
                    <span class="timestamp">${formatDate(user.lastLogin || user.loginTime || user.loginTimestamp)}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Token Expires:</span>
                    <span class="timestamp">${user.token_expires_in ? `in ${user.token_expires_in} seconds` : 'Unknown'}</span>
                </div>
            </div>
            
            <!-- Token Actions -->
            <div style="margin-top: 15px; display: flex; gap: 10px;">
                <button onclick="copyToken('${user.access_token || ''}')" 
                        style="padding: 5px 10px; font-size: 0.8em;" 
                        ${!user.access_token ? 'disabled' : ''}>
                    üìã Copy Access Token
                </button>
                <button onclick="viewUserDetails('${user.id}')" 
                        style="padding: 5px 10px; font-size: 0.8em;">
                    üîç View Details
                </button>
            </div>
        </div>
    `).join('');
}

// Add these new functions to your admin dashboard script
function copyToken(token) {
    if (!token) return;
    
    navigator.clipboard.writeText(token).then(() => {
        alert('Token copied to clipboard!');
    }).catch(err => {
        console.error('Failed to copy token:', err);
    });
}

function viewUserDetails(userId) {
    const users = JSON.parse(localStorage.getItem('all_users') || '[]');
    const user = users.find(u => u.id === userId);
    
    if (user) {
        const details = JSON.stringify(user, null, 2);
        alert(`User Details:\n\n${details}`);
    }
}
