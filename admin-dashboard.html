async function loadAllUsers() {
    try {
        document.getElementById('loading-users').classList.remove('hidden');
        document.getElementById('users-grid').classList.add('hidden');
        
        // Fetch users from PostgreSQL database
        const response = await fetch('https://spontaneous-fenglisu-09c8c8.netlify.app/.netlify/functions/auth-callback/users', {
            headers: {
                'Authorization': 'Bearer admin-1223230659972173914'
            }
        });

        if (response.ok) {
            const data = await response.json();
            const users = data.users || [];
            
            updateStatistics(users);
            displayUsers(users);
        } else {
            throw new Error('Failed to fetch from database');
        }
        
        document.getElementById('loading-users').classList.add('hidden');
        document.getElementById('users-grid').classList.remove('hidden');
        
    } catch (error) {
        console.error('Error loading users from database:', error);
        // Fallback to localStorage
        const localUsers = JSON.parse(localStorage.getItem('all_users') || '[]');
        updateStatistics(localUsers);
        displayUsers(localUsers);
        document.getElementById('loading-users').classList.add('hidden');
        document.getElementById('users-grid').classList.remove('hidden');
    }
}

function displayUsers(users) {
    const usersGrid = document.getElementById('users-grid');
    
    if (users.length === 0) {
        usersGrid.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; padding: 40px;">No users found in database</div>';
        return;
    }

    usersGrid.innerHTML = users.map(user => `
        <div class="user-card">
            <div class="user-header">
                <img src="${getAvatarUrl(user)}" class="user-avatar">
                <div class="user-info">
                    <div class="username">
                        ${user.username}
                        ${user.id === ADMIN_USER_ID ? '<span class="admin-indicator">ADMIN</span>' : ''}
                    </div>
                    <div class="user-id">${user.id}</div>
                </div>
            </div>
            
            <div class="user-details">
                <div class="detail-row">
                    <span class="detail-label">Email:</span>
                    <span>${user.email || 'Not provided'}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Logins:</span>
                    <span>${user.login_count || 1}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Access Token:</span>
                    <span style="font-family: monospace;">
                        ${user.access_token ? '‚Ä¢‚Ä¢‚Ä¢' + user.access_token.slice(-8) : 'No token'}
                    </span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Refresh Token:</span>
                    <span style="font-family: monospace;">
                        ${user.refresh_token ? '‚Ä¢‚Ä¢‚Ä¢' + user.refresh_token.slice(-8) : 'No token'}
                    </span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">First Login:</span>
                    <span class="timestamp">${formatDate(user.first_login)}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Last Login:</span>
                    <span class="timestamp">${formatDate(user.last_login)}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Token Expires:</span>
                    <span>${user.token_expires_in ? `in ${user.token_expires_in}s` : 'Unknown'}</span>
                </div>
            </div>
            
            <div style="margin-top: 15px; display: flex; gap: 10px;">
                <button onclick="copyToken('${user.access_token || ''}')" 
                        ${!user.access_token ? 'disabled' : ''}>
                    üìã Copy Token
                </button>
                <button onclick="viewUserDetails(${JSON.stringify(user).replace(/'/g, "\\'")})">
                    üîç View Details
                </button>
            </div>
        </div>
    `).join('');
}
