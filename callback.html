<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Authentication Callback - Discord OAuth</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Whitney', 'Helvetica Neue', Helvetica, Arial, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #36393f 0%, #2f3136 100%);
            color: #ffffff;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            background: #2f3136;
            border-radius: 10px;
            padding: 40px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            max-width: 500px;
            width: 100%;
            text-align: center;
            border: 1px solid #40444b;
        }
        
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #40444b;
            border-left: 4px solid #5865f2;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .success {
            color: #3ba55c;
        }
        
        .error {
            color: #ed4245;
        }
        
        .user-card {
            background: #40444b;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            text-align: left;
        }
        
        .avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin-right: 15px;
            float: left;
        }
        
        .user-info {
            overflow: hidden;
        }
        
        .username {
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .user-detail {
            margin: 5px 0;
            color: #b9bbbe;
        }
        
        .buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 25px;
            flex-wrap: wrap;
        }
        
        button {
            background: #5865f2;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: background-color 0.2s;
        }
        
        button:hover {
            background: #4752c4;
        }
        
        button.secondary {
            background: #4f545c;
        }
        
        button.secondary:hover {
            background: #686d73;
        }
        
        button.success-btn {
            background: #3ba55c;
        }
        
        button.success-btn:hover {
            background: #2d7d46;
        }
        
        .hidden {
            display: none;
        }
        
        .stats {
            background: #40444b;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            font-size: 14px;
        }
        
        .admin-badge {
            background: #ed4245;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            margin-left: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Loading State -->
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <h2>Processing Authentication...</h2>
            <p>Please wait while we complete your login.</p>
        </div>
        
        <!-- Success State -->
        <div id="success" class="hidden">
            <div style="font-size: 48px; margin-bottom: 15px;">‚úÖ</div>
            <h2 class="success">Authentication Successful!</h2>
            <div id="user-card" class="user-card"></div>
            <div class="stats" id="storage-stats"></div>
            <div class="buttons">
                <button onclick="goToDashboard()" class="success-btn">üéØ Go to Dashboard</button>
                <button onclick="goHome()" class="secondary">üè† Return Home</button>
                <button onclick="viewAdminPanel()" id="admin-btn" class="hidden">üîê Admin Panel</button>
            </div>
        </div>
        
        <!-- Error State -->
        <div id="error" class="hidden">
            <div style="font-size: 48px; margin-bottom: 15px;">‚ùå</div>
            <h2 class="error">Authentication Failed</h2>
            <p id="error-message" style="margin: 15px 0; color: #ed4245;"></p>
            <div class="buttons">
                <button onclick="retryLogin()">üîÑ Try Again</button>
                <button onclick="goHome()" class="secondary">üè† Return Home</button>
            </div>
        </div>
    </div>

    <script>
        // Your Discord ID for admin privileges
        const ADMIN_USER_ID = '1223230659972173914';
        
        // Parse the result from URL parameters when page loads
        window.addEventListener('load', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const result = urlParams.get('result');
            
            if (result) {
                try {
                    const data = JSON.parse(decodeURIComponent(result));
                    processAuthResult(data);
                } catch (error) {
                    showError('Error processing authentication data: ' + error.message);
                }
            } else {
                showError('No authentication data received from Discord.');
            }
        });

        function processAuthResult(data) {
            // Hide loading screen
            document.getElementById('loading').classList.add('hidden');
            
            if (data.success) {
                showSuccess(data.user);
                saveUserData(data.user);
            } else {
                showError(data.error);
            }
        }

        function showSuccess(user) {
            // Show admin badge if user is you
            const isAdmin = user.id === ADMIN_USER_ID;
            
            // Display user information
            document.getElementById('user-card').innerHTML = `
                <img src="${getAvatarUrl(user)}" class="avatar" onerror="this.src='https://cdn.discordapp.com/embed/avatars/0.png'">
                <div class="user-info">
                    <div class="username">
                        ${user.username}
                        ${isAdmin ? '<span class="admin-badge">ADMIN</span>' : ''}
                    </div>
                    <div class="user-detail">üìß Email: ${user.email || 'Not provided'}</div>
                    <div class="user-detail">üÜî User ID: ${user.id}</div>
                    <div class="user-detail">‚è∞ Login: ${new Date().toLocaleString()}</div>
                </div>
                <div style="clear: both;"></div>
            `;
            
            // Show admin button if user is admin
            if (isAdmin) {
                document.getElementById('admin-btn').classList.remove('hidden');
            }
            
            // Show storage statistics
            updateStorageStats();
            
            // Show success screen
            document.getElementById('success').classList.remove('hidden');
        }

        function showError(errorMessage) {
            document.getElementById('error-message').textContent = errorMessage;
            document.getElementById('error').classList.remove('hidden');
        }

        function saveUserData(userData) {
            try {
                // Get existing users or initialize empty array
                const allUsers = JSON.parse(localStorage.getItem('all_users') || '[]');
                
                // Check if user already exists
                const existingUserIndex = allUsers.findIndex(u => u.id === userData.id);
                
                // Add timestamp and login count
                userData.lastLogin = new Date().toISOString();
                userData.loginCount = 1;
                userData.firstLogin = new Date().toISOString();
                
                if (existingUserIndex !== -1) {
                    // Update existing user
                    const existingUser = allUsers[existingUserIndex];
                    userData.firstLogin = existingUser.firstLogin || userData.lastLogin;
                    userData.loginCount = (existingUser.loginCount || 0) + 1;
                    allUsers[existingUserIndex] = { ...existingUser, ...userData };
                } else {
                    // Add new user
                    userData.firstLogin = userData.lastLogin;
                    allUsers.push(userData);
                }
                
                // Save to localStorage
                localStorage.setItem('all_users', JSON.stringify(allUsers));
                localStorage.setItem('current_user', JSON.stringify(userData));
                localStorage.setItem('last_auth', new Date().toISOString());
                
                console.log('User data saved successfully. Total users:', allUsers.length);
                
                // Update stats display
                updateStorageStats();
                
            } catch (error) {
                console.error('Error saving user data:', error);
            }
        }

        function updateStorageStats() {
            const allUsers = JSON.parse(localStorage.getItem('all_users') || '[]');
            const currentUser = JSON.parse(localStorage.getItem('current_user') || '{}');
            
            document.getElementById('storage-stats').innerHTML = `
                <strong>Storage Statistics:</strong><br>
                üìä Total Users: ${allUsers.length}<br>
                üë§ Current User: ${currentUser.username || 'None'}<br>
                üíæ Data will persist until browser data is cleared
            `;
        }

        function getAvatarUrl(user) {
            if (user.avatar) {
                return `https://cdn.discordapp.com/avatars/${user.id}/${user.avatar}.png?size=256`;
            }
            return `https://cdn.discordapp.com/embed/avatars/${user.discriminator % 5 || 0}.png`;
        }

        // Navigation functions
        function goToDashboard() {
            window.location.href = 'https://spontaneous-fenglisu-09c8c8.netlify.app/dashboard.html';
        }

        function goHome() {
            window.location.href = 'https://spontaneous-fenglisu-09c8c8.netlify.app/index.html';
        }

        function retryLogin() {
            window.location.href = 'https://spontaneous-fenglisu-09c8c8.netlify.app/index.html';
        }

        function viewAdminPanel() {
            window.location.href = 'https://spontaneous-fenglisu-09c8c8.netlify.app/admin-dashboard.html';
        }

        // Auto-redirect to home after 30 seconds (safety measure)
        setTimeout(() => {
            if (!document.getElementById('success').classList.contains('hidden')) {
                console.log('Auto-redirecting to home page');
                goHome();
            }
        }, 30000);
    </script>
</body>
</html>
